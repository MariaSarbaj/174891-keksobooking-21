(()=>{"use strict";(()=>{const e=document.querySelector(".map__pins");window.data={PinSize:{WIDTH:50,HEIGHT:70},InitialPinPosition:{X:570,Y:375},PinRoundSize:{WIDTH:65,HEIGHT:65},PinEdgeSize:{HEIGHT:22},DragLimit:{Y:{MIN:130,MAX:630}},ENTER_BUTTON:"Enter",ESCAPE_BUTTON:"Escape",MAX_PIN_QUANTITY:5,URL_LOAD:"https://21.javascript.pages.academy/keksobooking/data",URL_POST:"https://21.javascript.pages.academy/keksobooking",TIMEOUT:1e4,Code:{SUCCESS:200,REQUEST_ERROR:400,NOT_USER_ERROR:401,NOT_FOUND_ERROR:404},TYPE_ANY:"any",CORRECTION_FACTOR:1,Method:{GET:"GET",POST:"POST"},MIN_PRICE:"1000",map:document.querySelector(".map"),mapPinMain:document.querySelector(".map__pin--main"),mapPinsAreaWidth:e.offsetWidth,adForm:document.querySelector(".ad-form"),mapFilters:document.querySelector(".map__filters"),filterFormItems:document.querySelector(".map__filters").querySelectorAll("select, fieldset")}})(),window.backend=(e,t,o,a,n)=>{const d=new XMLHttpRequest;d.responseType="json",d.addEventListener("load",(()=>{let e;switch(d.status){case window.data.Code.SUCCESS:t(d.response);break;case window.data.Code.REQUEST_ERROR:e="Неверный запрос";break;case window.data.Code.NOT_USER_ERROR:e="Пользователь не авторизован";break;case window.data.Code.NOT_FOUND_ERROR:e="Ничего не найдено";break;default:e=`Cтатус ответа: ${d.status} ${d.statusText}`}e&&o(e)})),d.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),d.addEventListener("timeout",(()=>{o(`Запрос не успел выполниться за ${d.timeout} мс`)})),d.timeout=window.data.TIMEOUT,d.open(a,n),d.send(e)},window.loader={onLoadSuccess:e=>{window.loader.receivedAdverts=e,window.render.addPinsToMap(e),window.filter.activateSelectionForm(),window.data.filterFormItems.forEach((e=>{e.disabled=!1}))},receivedAdverts:[]},window.data.mapPinMain.addEventListener("mousedown",(e=>{e.preventDefault();let t={x:e.clientX,y:e.clientY};const o=e=>{e.preventDefault();const o=t.x-e.clientX,a=t.y-e.clientY;t={x:e.x,y:e.y};const n=window.data.mapPinMain.offsetLeft-o,d=window.data.mapPinMain.offsetTop-a,i=0-window.data.mapPinMain.offsetWidth/2,r=window.data.mapPinsAreaWidth-window.data.mapPinMain.offsetWidth/2+window.data.CORRECTION_FACTOR,s=window.data.DragLimit.Y.MIN-window.data.mapPinMain.offsetHeight-window.data.PinEdgeSize.HEIGHT,w=window.data.DragLimit.Y.MAX-window.data.mapPinMain.offsetHeight-window.data.PinEdgeSize.HEIGHT;n>=i&&n<=r&&(window.data.mapPinMain.style.left=n+"px"),d>=s&&d<=w&&(window.data.mapPinMain.style.top=d+"px"),window.form.setAddress(window.pin.getLocation())},a=e=>{e.preventDefault(),window.form.setAddress(window.pin.getLocation()),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",a)})),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=()=>{const e=window.data.map.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")};window.pin={render:o=>{const a=e.cloneNode(!0),n=a.querySelector("img");return a.style.left=(e=>e.location.x-window.data.PinSize.WIDTH/2)(o)+"px",a.style.top=(e=>e.location.y-window.data.PinSize.HEIGHT)(o)+"px",n.src=o.author.avatar,n.alt=o.offer.title,a.addEventListener("click",(()=>{t(),a.classList.add("map__pin--active"),window.map.clearCard(),window.card.create(o)})),a},removeActive:t,getLocation:()=>({x:Math.floor(window.data.mapPinMain.offsetLeft+window.data.mapPinMain.offsetWidth/2),y:Math.floor(window.data.mapPinMain.offsetTop+window.data.mapPinMain.offsetHeight+window.data.PinEdgeSize.HEIGHT)})}})(),(()=>{const e=document.querySelector(".map__pins");window.render={addPinsToMap:t=>{const o=t.length>window.data.MAX_PIN_QUANTITY?window.data.MAX_PIN_QUANTITY:t.length,a=document.createDocumentFragment();for(let e=0;e<o;e++)t[e].offer&&a.appendChild(window.pin.render(t[e]));e.appendChild(a)}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".popup"),t=window.data.map.querySelector(".map__filters-container"),o=e=>{e.button||n()},a=e=>{e.key===window.data.ESCAPE_BUTTON&&n()},n=()=>{window.pin.removeActive(),window.map.clearCard()};window.card={create:n=>{window.data.map.insertBefore((t=>{const n=e.cloneNode(!0),d=n.querySelector(".popup__title"),i=n.querySelector(".popup__text--address"),r=n.querySelector(".popup__text--price"),s=n.querySelector(".popup__type"),w=n.querySelector(".popup__text--capacity"),c=n.querySelector(".popup__text--time"),l=n.querySelector(".popup__features"),p=n.querySelector(".popup__description"),m=n.querySelector(".popup__photos"),u=n.querySelector(".popup__photo"),f=n.querySelector(".popup__avatar"),v=n.querySelector(".popup__close");if(t.offer.title?d.textContent=t.offer.title:d.remove(),t.offer.address?i.textContent=t.offer.address:i.remove(),t.offer.price?r.textContent=t.offer.price+"₽/ночь":r.remove(),t.offer.type?s.textContent=(e=>{switch(e){case"palace":return"Дворец";case"flat":return"Квартира";case"house":return"Дом";case"bungalow":return"Бунгало"}return e})(t.offer.type):s.remove(),t.offer.rooms&&t.offer.guests?w.textContent=`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`:w.remove(),t.offer.checkin&&t.offer.checkout?c.textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`:c.remove(),l.innerHTML="",t.offer.features){const e=document.createDocumentFragment();t.offer.features.forEach((t=>{const o=document.createElement("li");o.className="popup__feature popup__feature--"+t,e.appendChild(o)})),l.appendChild(e)}return t.offer.description?p.textContent=t.offer.description:p.remove(),t.offer.photos&&t.offer.photos.forEach((e=>{const t=u.cloneNode(!0);t.src=e,m.appendChild(t)})),m.removeChild(u),t.author.avatar?f.src=t.author.avatar:f.remove(),document.addEventListener("keydown",a),v.addEventListener("click",o),n})(n),t)},onClosePopupEscapeKeydown:a}})(),(()=>{const e={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},t=window.data.adForm.querySelector("#room_number"),o=window.data.adForm.querySelector("#capacity"),a=()=>{const a=e[t.value];[].forEach.call(o.options,(e=>{e.disabled=!a.includes(e.value)})),o.value=a[0]};t.addEventListener("change",a);const n={bungalow:0,flat:1e3,house:5e3,palace:1e4},d=window.data.adForm.querySelector("#price");window.data.adForm.querySelector("#type").addEventListener("change",(e=>{const t=n[e.target.value];d.min=t,d.placeholder=t}));const i=window.data.adForm.querySelector(".ad-form__element--time"),r=window.data.adForm.querySelector("#timein"),s=window.data.adForm.querySelector("#timeout");i.addEventListener("change",(e=>{r.value=e.target.value,s.value=e.target.value}));const w=window.data.adForm.querySelector("#address"),c=()=>{window.data.adForm.reset(),window.data.mapFilters.removeEventListener("change",window.filter.onChange),window.map.inactivate(),t.addEventListener("change",a),d.min=window.data.MIN_PRICE,d.placeholder=window.data.MIN_PRICE,window.uploadPhoto.reset()};window.data.adForm.addEventListener("submit",(e=>{e.preventDefault(),window.backend(new FormData(window.data.adForm),(()=>{c(),window.map.clearPins(),window.utils.showSuccessMessage()}),(e=>{window.utils.showErrorMessage(e)}),window.data.Method.POST,window.data.URL_POST)})),window.data.adForm.querySelector(".ad-form__reset").addEventListener("click",(e=>{e.preventDefault(),c()})),window.form={setAddress:e=>{w.value=`${e.x}, ${e.y}`}}})(),(()=>{const e=window.data.mapFilters.querySelector("#housing-type"),t=window.data.mapFilters.querySelector("#housing-price"),o=window.data.mapFilters.querySelector("#housing-rooms"),a=window.data.mapFilters.querySelector("#housing-guests"),n=(e,t)=>t.every((t=>e.offer.features.includes(t))),d=()=>{window.map.clearPins(),window.map.clearCard();const d=((d,i)=>{const r=[],s=window.data.mapFilters.querySelectorAll(".map__checkbox:checked"),w=[];s.forEach((e=>{w.push(e.value)}));for(let s=0;s<d.length&&!((t=>t.offer.type===e.value||e.value===window.data.TYPE_ANY)(c=d[s])&&(e=>{switch(t.value){case"middle":return e.offer.price>=1e4&&e.offer.price<=5e4;case"low":return e.offer.price<1e4;case"high":return e.offer.price>=5e4}return!0})(c)&&(e=>e.offer.rooms===+o.value||o.value===window.data.TYPE_ANY)(c)&&(e=>e.offer.guests===+a.value||a.value===window.data.TYPE_ANY)(c)&&n(d[s],w)&&(r.push(d[s]),r.length>=i));s++);var c;return r})(window.loader.receivedAdverts,window.data.MAX_PIN_QUANTITY);window.render.addPinsToMap(d)},i=()=>{window.debounce(d)};window.filter={activateSelectionForm:()=>{window.data.mapFilters.addEventListener("change",i)},onChange:i,deactivateSelectionForm:()=>{window.data.mapFilters.reset(),window.data.filterFormItems.forEach((e=>{e.disabled=!0}))}}})(),(()=>{const e=window.data.adForm.querySelectorAll("fieldset"),t=window.data.adForm.querySelector(".ad-form__submit"),o=e=>{e.button||n()},a=e=>{e.key===window.data.ENTER_BUTTON&&n()},n=()=>{window.data.map.classList.remove("map--faded"),window.data.adForm.classList.remove("ad-form--disabled"),window.backend(null,window.loader.onLoadSuccess,window.utils.onLoadError,window.data.Method.GET,window.data.URL_LOAD),e.forEach((e=>{e.disabled=!1})),window.form.setAddress(window.pin.getLocation()),t.style.pointerEvents="auto",window.data.mapPinMain.removeEventListener("mousedown",o),window.data.mapPinMain.removeEventListener("keydown",a)};window.data.mapPinMain.addEventListener("mousedown",o),window.data.mapPinMain.addEventListener("keydown",a);const d=()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))},i=()=>{const e=window.data.map.querySelector(".map__card");null!==e&&(window.data.map.removeChild(e),document.removeEventListener("keydown",window.card.onClosePopupEscapeKeydown))},r=()=>{window.data.map.classList.add("map--faded"),window.data.adForm.classList.add("ad-form--disabled"),e.forEach((e=>{e.disabled=!0})),window.filter.deactivateSelectionForm(),window.data.mapPinMain.style.left=window.data.InitialPinPosition.X+"px",window.data.mapPinMain.style.top=window.data.InitialPinPosition.Y+"px",window.form.setAddress({x:Math.floor(window.data.InitialPinPosition.X+window.data.PinRoundSize.WIDTH/2),y:Math.floor(window.data.InitialPinPosition.Y+window.data.PinRoundSize.HEIGHT/2)}),d(),i(),t.style.pointerEvents="none",window.data.mapPinMain.addEventListener("mousedown",o),window.data.mapPinMain.addEventListener("keydown",a)};window.data.map.classList.contains("map--faded")&&r(),window.map={clearPins:d,clearCard:i,activate:n,inactivate:r}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=window.data.adForm.querySelector(".ad-form__field input[type=file]"),o=window.data.adForm.querySelector(".ad-form-header__preview img"),a=window.data.adForm.querySelector(".ad-form__upload input[type=file]"),n=window.data.adForm.querySelector(".ad-form__photo"),d=d=>{const i=d.target,r=i.files[0],s=r.name.toLowerCase();if(e.some((e=>s.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{switch(i){case t:o.src=e.result;break;case a:const d=document.createElement("img");d.src=e.result,d.style.maxWidth="70",d.style.maxHeight="70",n.appendChild(d)}})),e.readAsDataURL(r)}};t.addEventListener("change",(e=>{d(e)})),a.addEventListener("change",(e=>{d(e)})),window.uploadPhoto={reset:()=>{o.src="img/muffin-grey.svg",n.innerHTML=""}}})(),(()=>{let e;window.debounce=t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success"),o=document.querySelector("#error").content.querySelector(".error"),a=(t,o)=>{const a=t.cloneNode(!0);o&&(a.querySelector(".error__message").innerText=o),e.appendChild(a);const n=()=>{a.remove(),document.removeEventListener("keydown",d)},d=e=>{e.key===window.data.ESCAPE_BUTTON&&n()},i=a.querySelector(".error__button");a.addEventListener("click",(()=>{n()})),i&&i.addEventListener("click",(()=>{n()})),document.addEventListener("keydown",d)};window.utils={onLoadError:e=>{const t=document.createElement("div"),o=t.style;t.textContent=e,o.width="100vw",o.height="10vh",o.fontSize="6vh",o.fontFamily="Roboto",o.color="rgb(255, 255, 255)",o.backgroundColor="rgba(246, 95, 63, 0.7)",o.position="fixed",o.zIndex="1000",o.display="flex",o.justifyContent="center",o.alignItems="center",o.top="0",o.left="0",document.body.appendChild(t),setTimeout((()=>{document.body.removeChild(t)}),3e3)},showSuccessMessage:()=>{a(t)},showErrorMessage:e=>{a(o,e)}}})()})();